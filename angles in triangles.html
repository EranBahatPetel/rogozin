<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תרגול חישובי זוויות</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #cccccc;
            padding: 10px 20px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .header-bar span {
            margin-left: 20px;
        }
        
        /* --- *** שינוי: עיצוב קל לתפריטים *** --- */
        .header-bar select {
            padding: 5px;
            font-size: 0.9em;
            font-weight: bold;
            border: 1px solid #888;
            border-radius: 4px;
        }
        /* --- *** סוף שינוי *** --- */

        .main-container {
            display: flex;
            margin-top: 20px;
            padding: 0 10px;
            gap: 15px;
        }

        .controls-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            align-self: flex-start; /* נצמיד להתחלה */
        }

        .controls-panel button {
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .controls-panel button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-green { background-color: #4CAF50; }
        .btn-blue { background-color: #008CBA; }
        .btn-red { background-color: #f44336; }
        .btn-gray { background-color: #555; }

        .canvas-container {
            flex: 3;
            border: 2px solid #333;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .inputs-panel {
            flex: 1;
            padding: 10px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            align-self: flex-start; /* נצמיד להתחלה */
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .input-group label {
            font-size: 1.2em;
            font-weight: bold;
            margin-left: 8px;
            min-width: 30px;
        }

        .input-group input {
            width: 60px;
            padding: 5px;
            font-size: 1.1em;
            text-align: center;
        }
        
        .input-group input:disabled {
            background-color: #eee;
        }

        .feedback {
            margin-right: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        #score-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
            font-size: 0.9em;
            line-height: 1.6;
        }

    </style>
</head>
<body>

    <div class="header-bar">
        <span>ניקוד: <span id="score">0</span></span>
        <span>זמן: <span id="timer">0</span> שניות</span>
        
        <div>
            <select id="difficulty">
                <option value="1">רמת קושי 1</option>
                <option value="2">רמת קושי 2</option>
                <option value="3">רמת קושי 3</option>
                <option value="4">רמת קושי 4</option>
                <option value="5">רמת קושי 5</option>
            </select>

            <select id="exerciseScope" style="margin-right: 10px;">
                <option value="current">רק הרמה הנוכחית</option>
                <option value="upto">עד הרמה הנוכחית</option>
            </select>
            </div>
    </div>

    <div class="main-container">
        
        <div class="controls-panel">
            <button id="checkAnswer" class="btn-green">יש לי תשובה</button>
            <button id="getHint" class="btn-blue">אפשר רמז ?</button>
            <button id="showSolution" class="btn-red">פתרון בבקשה</button>
            <div id="score-summary"></div>
            <button id="nextExercise" class="btn-gray" style="display: none;">עוד תרגיל</button>
        </div>

        <div class="canvas-container">
            <canvas id="geometryCanvas" width="600" height="400"></canvas>
        </div>

        <div class="inputs-panel" id="inputs-panel">
            </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- בחירת אלמנטים מה-DOM ---
            const scoreSpan = document.getElementById('score');
            const timerSpan = document.getElementById('timer');
            const difficultySelect = document.getElementById('difficulty');
			let difficulty = 1;
            const exerciseScopeSelect = document.getElementById('exerciseScope'); // *** הוספה ***
            
            const checkAnswerBtn = document.getElementById('checkAnswer');
            const getHintBtn = document.getElementById('getHint');
            const showSolutionBtn = document.getElementById('showSolution');
            const nextExerciseBtn = document.getElementById('nextExercise');
            
            const canvas = document.getElementById('geometryCanvas');
            const ctx = canvas.getContext('2d');
            
            const inputsPanel = document.getElementById('inputs-panel');
            const scoreSummary = document.getElementById('score-summary');

            // --- משתני מצב ---
            let totalScore = 0;
            let timerInterval;
            let currentProblemSolution = {};
            let lastExerciseFunction = null;
            
            // --- צבעים קבועים לנעלמים ---
            const angleColors = {
                A: '#0000FF', // כחול
                B: '#FF0000', // אדום
                C: '#008000', // ירוק
                D: '#FFA500',  // כתום
                E: '#800080'  // סגול
            };


            // --- פונקציות ליבה ---

            /** מתחיל את הטיימר שסופר שניות */
            function startTimer() {
                let seconds = 0;
                if (timerInterval) clearInterval(timerInterval);
                timerSpan.textContent = 0;
                timerInterval = setInterval(() => {
                    seconds++;
                    timerSpan.textContent = seconds;
                }, 1000);
            }

            /**
             * יוצר את תיבות הקלט עבור הזוויות הלא ידועות
             */
            function createInputBoxes(solution, colors) {
                inputsPanel.innerHTML = '';
                for (const angle in solution) {
                    const div = document.createElement('div');
                    div.className = 'input-group';
                    
                    const label = document.createElement('label');
                    label.textContent = `${angle}:`;
                    label.htmlFor = `angle_${angle}`;
                    
                    if (colors && colors[angle]) {
                        label.style.color = colors[angle];
                        label.style.fontWeight = 'bold';
                    }

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `angle_${angle}`;
                    input.min = "0";
                    input.max = "360";

                    const feedback = document.createElement('span');
                    feedback.id = `feedback_${angle}`;
                    feedback.className = 'feedback';
                    
                    div.append(label, input, feedback);
                    inputsPanel.append(div);
                }
            }

            /** מאפס את מצב הכפתורים והמשוב לתרגיל חדש */
            function resetExerciseState() {
                scoreSummary.innerHTML = '';
                nextExerciseBtn.style.display = 'none';
                
                checkAnswerBtn.disabled = false;
                getHintBtn.disabled = false;
                showSolutionBtn.disabled = false;
            }


            /**
             * פונקציית עזר: ציור קשת ותווית (עם ביטול סיבוב לטקסט)
             */
            function drawAngleLabel(vertex, p1, p2, color, label, radius = 25, textOffset = 15, rotationAngle = 0) {
                const angle1 = Math.atan2(p1.y - vertex.y, p1.x - vertex.x);
                const angle2 = Math.atan2(p2.y - vertex.y, p2.x - vertex.x);

                let angleDiff = angle2 - angle1;
                while (angleDiff <= -Math.PI) angleDiff += 2 * Math.PI;
                while (angleDiff > Math.PI) angleDiff -= 2 * Math.PI;
                
                const midAngle = angle1 + angleDiff / 2;
                const isCounterClockwise = angleDiff < 0;

                // 1. ציור הקשת
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(vertex.x, vertex.y, radius, angle1, angle2, isCounterClockwise);
                ctx.stroke();

                // 2. ציור הטקסט
                const textRadius = radius + textOffset;
                const textX = vertex.x + textRadius * Math.cos(midAngle);
                const textY = vertex.y + textRadius * Math.sin(midAngle);
                
                ctx.save();
                ctx.translate(textX, textY); 
                ctx.rotate(-rotationAngle); 
                
                ctx.fillStyle = color;
                ctx.textAlign = "center"; 
                ctx.textBaseline = "middle";
                ctx.fillText(label, 0, 0); 
                
                ctx.restore(); 
                
                ctx.fillStyle = "black";
                ctx.strokeStyle = "black";
                ctx.lineWidth = 2;
            }


            /**
             * פונקציה ראשית ליצירת תרגיל חדש
             */
            function generateExercise() {
                resetExerciseState();
                
                // --- *** שינוי: קריאת שני התפריטים *** ---
                difficulty = parseInt(difficultySelect.value);
                const scope = exerciseScopeSelect.value;
                // --- *** סוף שינוי *** ---
                
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                ctx.save(); 

                const rotationAngle = Math.random() * Math.PI * 2; 
                const canvasCenterX = canvas.width / 2; 
                const canvasCenterY = canvas.height / 2; 

                ctx.translate(canvasCenterX, canvasCenterY);
                ctx.scale(0.85, 0.85); // כווץ ב-15% למניעת חריגה
                ctx.rotate(rotationAngle);
                ctx.translate(-canvasCenterX, -canvasCenterY);

                ctx.font = "bold 18px Arial";
                ctx.fillStyle = "black";
                ctx.strokeStyle = "black";
                ctx.lineWidth = 2;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                const exercisesByDifficulty = {
                    1: [drawExercise_TriangleSum, drawExercise_RightTriangle],
                    2: [drawExercise_Supplementary, drawExercise_IsoscelesTriangle, drawExercise_Isosceles_HeadAngle],
                    3: [drawExercise_VerticalAngles, drawExercise_ParallelLines_Triangle],
                    4: [drawExercise_NestedTriangles, drawExercise_NestedTriangles_Var],
                    5: [drawExercise_Complex_Bowtie, drawExercise_Complex_Cevian] // רמה 5
                };

                // --- *** שינוי: לוגיקת בחירת מאגר התרגילים *** ---
                let pool = []; 
                
                if (scope === 'current') {
                    // "רק הרמה הנוכחית" - הלוגיקה הישנה
                    pool = exercisesByDifficulty[difficulty] || exercisesByDifficulty[1];
                } else {
                    // "עד הרמה הנוכחית" - לוגיקה חדשה
                    for (let i = 1; i <= difficulty; i++) {
                        if (exercisesByDifficulty[i]) {
                            pool = pool.concat(exercisesByDifficulty[i]);
                        }
                    }
                    if (pool.length === 0) {
                        pool = exercisesByDifficulty[1]; // גיבוי
                    }
                }
                // --- *** סוף שינוי *** ---

                let selectedFunction;
                if (pool.length === 1) {
                    selectedFunction = pool[0];
                } else {
                    do {
                        selectedFunction = pool[Math.floor(Math.random() * pool.length)];
                    } while (pool.length > 1 && selectedFunction === lastExerciseFunction);
                }

                lastExerciseFunction = selectedFunction;
                
                const exerciseData = selectedFunction(rotationAngle); 
                currentProblemSolution = exerciseData.solution; 
                
                ctx.restore(); // אפס את כל הטרנספורמציות

                createInputBoxes(currentProblemSolution, exerciseData.colors); 
                
                if (Object.keys(currentProblemSolution).length === 0 || !checkRemainingHints()) {
                    getHintBtn.disabled = true;
                }
            }
            
            function drawParallelMark(x1, y1, x2, y2) {
                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2;
                const angle = Math.atan2(y2 - y1, x2 - x1);
                const size = 10;
                const xA = midX - size * Math.cos(angle - Math.PI / 6);
                const yA = midY - size * Math.sin(angle - Math.PI / 6);
                const xB = midX - size * Math.cos(angle + Math.PI / 6);
                const yB = midY - size * Math.sin(angle + Math.PI / 6);
                ctx.beginPath();
                ctx.moveTo(xA, yA); ctx.lineTo(midX, midY); ctx.lineTo(xB, yB);
                ctx.stroke();
            }
            function drawTickMark(x1, y1, x2, y2) {
                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2;
                const angle = Math.atan2(y2 - y1, x2 - x1) + Math.PI / 2;
                const size = 8;
                ctx.beginPath();
                ctx.moveTo(midX - size * Math.cos(angle), midY - size * Math.sin(angle));
                ctx.lineTo(midX + size * Math.cos(angle), midY + size * Math.sin(angle));
                ctx.stroke();
            }


            // --- פונקציות שרטוט ותרגילים ---

            /**
             * תרגיל 1: סכום זוויות במשולש
             */
            function drawExercise_TriangleSum(rotationAngle) {
                const p1 = { x: 100, y: 300 }; 
                const p2 = { x: 300, y: 100 }; 
                const p3 = { x: 500, y: 300 }; 

                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y); 
                ctx.lineTo(p2.x, p2.y); 
                ctx.lineTo(p3.x, p3.y); 
                ctx.closePath();
                ctx.stroke();

                const valA = Math.floor(Math.random() * 40) + 40;
                const valB = Math.floor(Math.random() * 40) + 40;
                const solC = 180 - valA - valB;
                
                const currentColors = { A: angleColors.A };

                drawAngleLabel(p1, p3, p2, 'black', `${valA}°`, 25, 15, rotationAngle);
                drawAngleLabel(p3, p2, p1, 'black', `${valB}°`, 25, 15, rotationAngle);
                drawAngleLabel(p2, p1, p3, currentColors.A, 'A', 25, 15, rotationAngle);

                return { solution: { A: solC }, colors: currentColors };
            }


            /**
             * תרגיל 2: סכום זוויות במשולש + זוויות צמודות
             */
            function drawExercise_Supplementary(rotationAngle) {
                const pA = { x: 150, y: 100 }; 
                const pB = { x: 100, y: 300 }; 
                const pC = { x: 400, y: 300 }; 
                const pD = { x: 500, y: 300 }; 

                ctx.beginPath();
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y); 
                ctx.lineTo(pD.x, pD.y);
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pC.x, pC.y);
                ctx.stroke();

                const valA = Math.floor(Math.random() * 30) + 50;
                const valB = Math.floor(Math.random() * 30) + 50;
                const solA = 180 - valA - valB; 
                const solB = 180 - solA; 
                
                const currentColors = { A: angleColors.A, B: angleColors.B };

                drawAngleLabel(pA, pB, pC, 'black', `${valA}°`, 25, 15, rotationAngle);
                drawAngleLabel(pB, pC, pA, 'black', `${valB}°`, 25, 15, rotationAngle);
                drawAngleLabel(pC, pA, pB, currentColors.A, 'A', 25, 15, rotationAngle); 
                drawAngleLabel(pC, pD, pA, currentColors.B, 'B', 45, 15, rotationAngle); 

                return { solution: { A: solA, B: solB }, colors: currentColors };
            }
            
            /**
             * תרגיל 3: שני משולשים וזוויות קודקודיות (רמה 3)
             */
            function drawExercise_VerticalAngles(rotationAngle) {
                const pA = { x: 100, y: 100 };
                const pB = { x: 100, y: 300 };
                const pC = { x: 300, y: 200 }; 
                const pD = { x: 500, y: 100 };
                const pE = { x: 500, y: 300 };

                ctx.beginPath();
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pE.x, pE.y);
                ctx.moveTo(pB.x, pB.y); ctx.lineTo(pD.x, pD.y);
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y);
                ctx.moveTo(pD.x, pD.y); ctx.lineTo(pE.x, pE.y);
                ctx.stroke();
                
                const valBAC = Math.floor(Math.random() * 20) + 40;
                const valABC = Math.floor(Math.random() * 20) + 60;
                const valCED = Math.floor(Math.random() * 20) + 70;

                const solA = 180 - valBAC - valABC; 
                const solC = solA; 
                const solB = 180 - valCED - solC; 
                
                const currentColors = { A: angleColors.A, B: angleColors.B, C: angleColors.C };

                drawAngleLabel(pA, pB, pC, 'black', `${valBAC}°`, 25, 15, rotationAngle);
                drawAngleLabel(pB, pA, pC, 'black', `${valABC}°`, 25, 15, rotationAngle);
                drawAngleLabel(pE, pC, pD, 'black', `${valCED}°`, 25, 15, rotationAngle);

                drawAngleLabel(pC, pB, pA, currentColors.A, 'A', 25, 15, rotationAngle); 
                drawAngleLabel(pD, pC, pE, currentColors.B, 'B', 25, 15, rotationAngle); 
                drawAngleLabel(pC, pE, pD, currentColors.C, 'C', 25, 15, rotationAngle); 
                
                return { solution: { A: solA, B: solB, C: solC }, colors: currentColors };
            }

            /**
             * תרגיל 4: משולש ישר זווית (רמה 1)
             */
            function drawExercise_RightTriangle(rotationAngle) {
                const p1 = { x: 100, y: 300 }; 
                const p2 = { x: 100, y: 100 }; 
                const p3 = { x: 450, y: 300 }; 

                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
                ctx.lineTo(p3.x, p3.y); ctx.closePath();
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y - 20);
                ctx.lineTo(p1.x + 20, p1.y - 20);
                ctx.lineTo(p1.x + 20, p1.y);
                ctx.stroke();
                
                const val_p2 = Math.floor(Math.random() * 41) + 30;
                const sol_p3 = 90 - val_p2;
                
                const currentColors = { A: angleColors.A };

                drawAngleLabel(p2, p3, p1, 'black', `${val_p2}°`, 25, 15, rotationAngle);
                drawAngleLabel(p3, p1, p2, currentColors.A, 'A', 25, 15, rotationAngle);

                return { solution: { A: sol_p3 }, colors: currentColors };
            }

            /**
             * תרגיל 5: משולש שווה שוקיים (בסיס נתון)
             */
            function drawExercise_IsoscelesTriangle(rotationAngle) {
                const p1 = { x: 150, y: 300 }; 
                const p2 = { x: 300, y: 100 }; 
                const p3 = { x: 450, y: 300 }; 

                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
                ctx.lineTo(p3.x, p3.y); ctx.closePath();
                ctx.stroke();

                drawTickMark(p1.x, p1.y, p2.x, p2.y);
                drawTickMark(p3.x, p3.y, p2.x, p2.y);
                
                const valB = Math.floor(Math.random() * 31) + 50;
                const solA = 180 - 2 * valB; 
                const solC = valB; 
                
                const currentColors = { A: angleColors.A, B: angleColors.B };

                drawAngleLabel(p1, p3, p2, 'black', `${valB}°`, 25, 15, rotationAngle);
                drawAngleLabel(p2, p1, p3, currentColors.A, 'A', 25, 15, rotationAngle);
                drawAngleLabel(p3, p2, p1, currentColors.B, 'B', 25, 15, rotationAngle);

                return { solution: { A: solA, B: solC }, colors: currentColors };
            }

            /**
             * תרגיל 6: משולש בין מקבילים (רמה 3)
             */
            function drawExercise_ParallelLines_Triangle(rotationAngle) {
                const y1 = 100, y2 = 300;
                const pA = { x: 300, y: y1 }; 
                const pB = { x: 100, y: y2 }; 
                const pC = { x: 450, y: y2 }; 
                const p_line1_left = {x: 50, y: y1};
                const p_line1_right = {x: 550, y: y1};

                ctx.beginPath();
                ctx.moveTo(p_line1_left.x, y1); ctx.lineTo(p_line1_right.x, y1);
                ctx.moveTo(50, y2); ctx.lineTo(550, y2);
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y);
                ctx.lineTo(pC.x, pC.y); ctx.closePath();
                ctx.stroke();
                
                drawParallelMark(70, y1, 100, y1);
                drawParallelMark(70, y2, 100, y2);

                const valB = Math.floor(Math.random() * 31) + 40;
                const valC = Math.floor(Math.random() * 31) + 40;
                
                const solA = 180 - valB - valC; 
                const solD = valB; 
                const solE = valC; 
                
                const currentColors = { A: angleColors.A, B: angleColors.B, C: angleColors.C };

                drawAngleLabel(pB, pC, pA, 'black', `${valB}°`, 25, 15, rotationAngle);
                drawAngleLabel(pC, pA, pB, 'black', `${valC}°`, 25, 15, rotationAngle);
                drawAngleLabel(pA, pB, pC, currentColors.A, 'A', 25, 15, rotationAngle); 
                drawAngleLabel(pA, p_line1_left, pB, currentColors.B, 'B', 45, 15, rotationAngle); 
                drawAngleLabel(pA, pC, p_line1_right, currentColors.C, 'C', 45, 15, rotationAngle); 
                
                return { solution: { A: solA, B: solD, C: solE }, colors: currentColors };
            }

            /**
             * תרגיל 7: משולשים מקוננים (רמה 4)
             */
            function drawExercise_NestedTriangles(rotationAngle) {
                const pA = { x: 300, y: 100 }; 
                const pB = { x: 100, y: 300 }; 
                const pC = { x: 500, y: 300 }; 
                const pD = { x: 350, y: 300 }; 

                ctx.beginPath();
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y);
                ctx.lineTo(pC.x, pC.y); ctx.closePath(); 
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pD.x, pD.y); 
                ctx.stroke();
                
                const valB = Math.floor(Math.random() * 20) + 40;
                const valC = Math.floor(Math.random() * 20) + 40;
                const valBAC_total = 180 - valB - valC;
                
                const valBAD = Math.floor(Math.random() * (valBAC_total - 30)) + 20;
                const solCAD = valBAC_total - valBAD; 
                
                const solBDA = 180 - valB - valBAD; 
                const solCDA = 180 - solBDA; 
                
                const currentColors = { A: angleColors.A, B: angleColors.B, C: angleColors.C };

                drawAngleLabel(pB, pA, pC, 'black', `${valB}°`, 25, 15, rotationAngle);
                drawAngleLabel(pC, pB, pA, 'black', `${valC}°`, 25, 15, rotationAngle);
                
                drawAngleLabel(pA, pB, pD, 'black', `${valBAD}°`, 25, 15, rotationAngle); // BAD
                drawAngleLabel(pA, pD, pC, currentColors.A, 'A', 45, 15, rotationAngle); // CAD
                
                drawAngleLabel(pD, pA, pB, currentColors.B, 'B', 25, 15, rotationAngle); // BDA
                drawAngleLabel(pD, pC, pA, currentColors.C, 'C', 45, 15, rotationAngle); // CDA

                return { solution: { A: solCAD, B: solBDA, C: solCDA }, colors: currentColors };
            }

            /**
             * תרגיל 8: משולשים מקוננים, וריאציה (רמה 4)
             */
            function drawExercise_NestedTriangles_Var(rotationAngle) {
                const pA = { x: 300, y: 100 }; 
                const pB = { x: 100, y: 300 }; 
                const pC = { x: 500, y: 300 }; 
                const pD = { x: 400, y: 200 }; 

                ctx.beginPath();
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y);
                ctx.lineTo(pC.x, pC.y); ctx.closePath(); 
                ctx.moveTo(pB.x, pB.y); ctx.lineTo(pD.x, pD.y); 
                ctx.stroke();

                const valA = Math.floor(Math.random() * 20) + 30;   
                const valDBC = Math.floor(Math.random() * 20) + 30; 
                const valBDC = Math.floor(Math.random() * 20) + 90; 

                const solC = 180 - valDBC - valBDC; 
                const solBDA = 180 - valBDC; 
                const solABD = 180 - valA - solBDA; 
                
                const currentColors = { A: angleColors.A, B: angleColors.B, C: angleColors.C };

                drawAngleLabel(pA, pC, pB, 'black', `${valA}°`, 25, 15, rotationAngle); 
                drawAngleLabel(pB, pD, pC, 'black', `${valDBC}°`, 45, 15, rotationAngle);
                drawAngleLabel(pD, pB, pC, 'black', `${valBDC}°`, 45, 15, rotationAngle);
                
                drawAngleLabel(pC, pA, pB, currentColors.A, 'A', 25, 15, rotationAngle); // C
                drawAngleLabel(pD, pA, pB, currentColors.B, 'B', 25, 15, rotationAngle); // BDA
                drawAngleLabel(pB, pA, pD, currentColors.C, 'C', 25, 15, rotationAngle); // ABD
                
                return { solution: { A: solC, B: solBDA, C: solABD }, colors: currentColors };
            }
            
            // --- *** פונקציות תרגילים חדשות *** ---

            /**
             * תרגיל 9: משולש שווה שוקיים (ראש נתון) (רמה 2)
             */
            function drawExercise_Isosceles_HeadAngle(rotationAngle) {
                const p1 = { x: 150, y: 300 }; // בסיס שמאל
                const p2 = { x: 300, y: 100 }; // קודקוד
                const p3 = { x: 450, y: 300 }; // בסיס ימין

                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
                ctx.lineTo(p3.x, p3.y); ctx.closePath();
                ctx.stroke();

                drawTickMark(p1.x, p1.y, p2.x, p2.y);
                drawTickMark(p3.x, p3.y, p2.x, p2.y);
                
                const valHead = Math.floor(Math.random() * 60) + 20; // 20-79
                const solBase = (180 - valHead) / 2;
                
                const currentColors = { A: angleColors.A, B: angleColors.B };

                drawAngleLabel(p2, p1, p3, 'black', `${valHead}°`, 25, 15, rotationAngle); // נתון
                drawAngleLabel(p1, p3, p2, currentColors.A, 'A', 25, 15, rotationAngle); // נעלם 1
                drawAngleLabel(p3, p2, p1, currentColors.B, 'B', 25, 15, rotationAngle); // נעלם 2

                return { solution: { A: solBase, B: solBase }, colors: currentColors };
            }

            /**
             * --- *** תרגיל 10: קומפלקס 1 (רמה 5) - "אפשרות ב" (הלא נכונה) לשעבר *** ---
             * --- *** תיקון: זו הפונקציה הנכונה מרמה 5 *** ---
             */
            function drawExercise_Complex_Bowtie(rotationAngle) {
                const center = {x: 300, y: 200};
                const pA = {x: 100, y: 100};
                const pB = {x: 100, y: 300};
                const pC = {x: 500, y: 300};
                const pD = {x: 500, y: 100};

                ctx.beginPath();
                // שני קווים נחתכים
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pC.x, pC.y); // A-center-C
                ctx.moveTo(pB.x, pB.y); ctx.lineTo(pD.x, pD.y); // B-center-D
                // סגירת משולשים
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y); // AB
                ctx.moveTo(pC.x, pC.y); ctx.lineTo(pD.x, pD.y); // CD
                ctx.stroke(); // *** הוספת קריאת stroke חסרה ***

                // נתונים
                const valA = Math.floor(Math.random() * 20) + 40; 
                const valB = Math.floor(Math.random() * 20) + 60; 
                const valD = Math.floor(Math.random() * 20) + 50; 

                // פתרונות
                const angleCenterLeft = 180 - valA - valB; 
                const valC = 180 - valD - angleCenterLeft; 
                
                const solCenterRight = angleCenterLeft; // קודקודית
                
                const currentColors = { A: angleColors.A, B: angleColors.B };

                drawAngleLabel(pA, center, pB, 'black', `${valA}°`, 25, 15, rotationAngle);
                drawAngleLabel(pB, pA, center, 'black', `${valB}°`, 25, 15, rotationAngle);
                drawAngleLabel(pD, center, pC, 'black', `${valD}°`, 25, 15, rotationAngle);
                
                drawAngleLabel(pC, pD, center, currentColors.A, 'A', 25, 15, rotationAngle); // זווית C
                drawAngleLabel(center, pC, pD, currentColors.B, 'B', 25, 15, rotationAngle); // מרכזית ימנית

                return { solution: { A: valC, B: solCenterRight }, colors: currentColors };
            }
            
            /**
             * --- *** תרגיל 11: קומפלקס 2 - משולש עם חוצה והארכה (רמה 5) *** ---
             */
            function drawExercise_Complex_Cevian(rotationAngle) {
                const pTop = {x: 300, y: 100};
                const pBottomLeft = {x: 100, y: 300};
                const pBottomRight = {x: 400, y: 300};
                const pExt = {x: 500, y: 300}; // הארכת הבסיס לימין
                const pMid = {x: 250, y: 300}; // נקודה על הבסיס

                ctx.beginPath();
                ctx.moveTo(pTop.x, pTop.y); ctx.lineTo(pBottomLeft.x, pBottomLeft.y); // שמאל
                ctx.moveTo(pTop.x, pTop.y); ctx.lineTo(pBottomRight.x, pBottomRight.y); // ימין
                ctx.moveTo(pBottomLeft.x, pBottomLeft.y); ctx.lineTo(pExt.x, pExt.y); // בסיס מוארך
                ctx.moveTo(pTop.x, pTop.y); ctx.lineTo(pMid.x, pMid.y); // חוצה פנימי
                ctx.stroke();

                // נתונים
                const valTopLeft = Math.floor(Math.random() * 20) + 30; // חלק שמאלי של זווית הראש
                const valBottomLeft = Math.floor(Math.random() * 20) + 50; // זווית בסיס שמאל
                const valExtRight = Math.floor(Math.random() * 20) + 110; // זווית חיצונית ימנית

                // חישובים
                const angleMidLeft = 180 - valTopLeft - valBottomLeft; // זווית בסיס פנימית שמאלית
                const angleMidRight = 180 - angleMidLeft; // זווית צמודה לה (פנימית ימנית)
                const angleBottomRightIn = 180 - valExtRight; // זווית בסיס פנימית ימנית
                
                // פתרונות
                const solTopRight = 180 - angleMidRight - angleBottomRightIn; // חלק ימני של זווית הראש
                const solMidRight = angleMidRight; 

                const currentColors = { A: angleColors.A, B: angleColors.B };

                // נתונים
                drawAngleLabel(pTop, pBottomLeft, pMid, 'black', `${valTopLeft}°`, 25, 15, rotationAngle);
                drawAngleLabel(pBottomLeft, pMid, pTop, 'black', `${valBottomLeft}°`, 25, 15, rotationAngle);
                drawAngleLabel(pBottomRight, pTop, pExt, 'black', `${valExtRight}°`, 25, 15, rotationAngle); // זווית חיצונית

                // נעלמים
                drawAngleLabel(pTop, pMid, pBottomRight, currentColors.A, 'A', 35, 15, rotationAngle); // חלק ימני עליון
                drawAngleLabel(pMid, pTop, pBottomRight, currentColors.B, 'B', 25, 15, rotationAngle); // זווית אמצעית ימנית

                return { solution: { A: solTopRight, B: solMidRight }, colors: currentColors };
            }

            // --- *** פונקציות תרגילים חדשות (רמה 6) *** ---

            /**
             * תרגיל 12: קומפלקס 3 (רמה 6) - "פפיון" עם זווית חיצונית
             */
            function drawExercise_Complex_Bowtie_1(rotationAngle) {
                // "פפיון" כמו ברמה 3
                const pA = { x: 100, y: 100 };
                const pB = { x: 100, y: 300 };
                const pC = { x: 300, y: 200 }; // מפגש
                const pD = { x: 500, y: 100 };
                const pE = { x: 500, y: 300 };
                
                // --- *** תיקון: חישוב נקודת הארכה קולינארית *** ---
                // הארכה של D-E אחרי E
                const pF = { 
                    x: pE.x + (pE.x - pD.x), 
                    y: pE.y + (pE.y - pD.y) 
                }; 
                
                ctx.beginPath();
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pE.x, pE.y); // A-C-E
                ctx.moveTo(pB.x, pB.y); ctx.lineTo(pD.x, pD.y); // B-C-D
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y); // AB
                ctx.moveTo(pD.x, pD.y); ctx.lineTo(pE.x, pE.y); // DE
                ctx.moveTo(pE.x, pE.y); ctx.lineTo(pF.x, pF.y); // הארכה E-F
                ctx.stroke();

                // נתונים
                const valBAC = Math.floor(Math.random() * 20) + 40; // 40-59
                const valABC = Math.floor(Math.random() * 20) + 60; // 60-79
                const valExtE = Math.floor(Math.random() * 20) + 100; // 100-119 (חיצונית)
                
                // פתרונות
                const solACB = 180 - valBAC - valABC; // נעלם A (סכום 1)
                const solDCE = solACB; // נעלם B (קודקודית)
                const solCED = 180 - valExtE; // נעלם C (צמודה)
                const solCDE = 180 - solCED - solDCE; // נעלם D (סכום 2)

                const currentColors = { A: angleColors.A, B: angleColors.B, C: angleColors.C, D: angleColors.D };

                // נתונים
                drawAngleLabel(pA, pC, pB, 'black', `${valBAC}°`, 25, 15, rotationAngle);
                drawAngleLabel(pB, pA, pC, 'black', `${valABC}°`, 25, 15, rotationAngle);
                
                // --- *** תיקון: ציור הזווית החיצונית הנכונה *** ---
                drawAngleLabel(pE, pC, pF, 'black', `${valExtE}°`, 40, 15, rotationAngle); // חיצונית (CEF)
                
                // נעלמים
                drawAngleLabel(pC, pB, pA, currentColors.A, 'A', 25, 15, rotationAngle); // ACB
                drawAngleLabel(pC, pE, pD, currentColors.B, 'B', 25, 15, rotationAngle); // DCE
                drawAngleLabel(pE, pC, pD, currentColors.C, 'C', 25, 15, rotationAngle); // CED
                drawAngleLabel(pD, pC, pE, currentColors.D, 'D', 25, 15, rotationAngle); // CDE

                return { solution: { A: solACB, B: solDCE, C: solCED, D: solCDE }, colors: currentColors };
            }

            /**
             * תרגיל 13: קומפלקס 4 (רמה 6) - וריאציה
             */
            function drawExercise_Complex_Bowtie_2(rotationAngle) {
                // אותה גיאומטריה
                const pA = { x: 100, y: 100 };
                const pB = { x: 100, y: 300 };
                const pC = { x: 300, y: 200 }; // מפגש
                const pD = { x: 500, y: 100 };
                const pE = { x: 500, y: 300 };
                
                // --- *** תיקון: חישוב נקודת הארכה קולינארית *** ---
                // הארכה של B-A אחרי A
                const pF = { 
                    x: pA.x + (pA.x - pB.x), 
                    y: pA.y + (pA.y - pB.y) 
                }; 

                ctx.beginPath();
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pE.x, pE.y); // A-C-E
                ctx.moveTo(pB.x, pB.y); ctx.lineTo(pD.x, pD.y); // B-C-D
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pB.x, pB.y); // AB
                ctx.moveTo(pD.x, pD.y); ctx.lineTo(pE.x, pE.y); // DE
                ctx.moveTo(pA.x, pA.y); ctx.lineTo(pF.x, pF.y); // הארכה A-F
                ctx.stroke();

                // נתונים
                const valExtA = Math.floor(Math.random() * 20) + 130; // 130-149
                const valABC = Math.floor(Math.random() * 20) + 60; // 60-79
                const valCDE = Math.floor(Math.random() * 20) + 70; // 70-89
                
                // פתרונות
                const solBAC = 180 - valExtA; // נעלם A (צמודה)
                const solACB = 180 - solBAC - valABC; // נעלם B (סכום 1)
                const solDCE = solACB; // נעלם C (קודקודית)
                const solCED = 180 - valCDE - solDCE; // נעלם D (סכום 2)

                const currentColors = { A: angleColors.A, B: angleColors.B, C: angleColors.C, D: angleColors.D };

                // נתונים
                drawAngleLabel(pA, pF, pC, 'black', `${valExtA}°`, 40, 15, rotationAngle); // חיצונית
                drawAngleLabel(pB, pA, pC, 'black', `${valABC}°`, 25, 15, rotationAngle);
                drawAngleLabel(pD, pC, pE, 'black', `${valCDE}°`, 25, 15, rotationAngle);
                
                // נעלמים
                drawAngleLabel(pA, pC, pB, currentColors.A, 'A', 25, 15, rotationAngle); // BAC
                drawAngleLabel(pC, pB, pA, currentColors.B, 'B', 25, 15, rotationAngle); // ACB
                drawAngleLabel(pC, pE, pD, currentColors.C, 'C', 25, 15, rotationAngle); // DCE
                drawAngleLabel(pE, pD, pC, currentColors.D, 'D', 25, 15, rotationAngle); // CED

                return { solution: { A: solBAC, B: solACB, C: solDCE, D: solCED }, colors: currentColors };
            }

            // --- *** סוף פונקציות חדשות *** ---


            // --- פונקציות כפתורים (ללא שינוי) ---

            function checkAnswers() {
                let correctCount = 0, wrongCount = 0, missingCount = 0, exerciseScore = 0;
                for (const angle in currentProblemSolution) {
                    const input = document.getElementById(`angle_${angle}`);
                    const feedback = document.getElementById(`feedback_${angle}`);
                    feedback.textContent = '';
                    if (input.disabled) continue;
                    
                    const userValueStr = input.value;
                    const correctValue = currentProblemSolution[angle];

                    if (userValueStr === '') {
                        missingCount++;
                        feedback.style.color = "#FF8C00";
                        feedback.textContent = `(התשובה: ${correctValue}°)`;
                    } else {
                        const userValue = Number(userValueStr);
                        if (userValue === correctValue) {
                            correctCount++;
                            //exerciseScore++;
							exerciseScore += difficulty;
                            feedback.style.color = "green";
                            feedback.textContent = '✔';
                        } else {
                            wrongCount++;
                            //exerciseScore--;
                            exerciseScore-=difficulty;
                            feedback.style.color = "red";
                            feedback.textContent = `(התשובה: ${correctValue}°)`;
                        }
                    }
                    input.disabled = true;
                }

                totalScore += exerciseScore;
                scoreSpan.textContent = totalScore;
                scoreSummary.innerHTML = `
                    <strong>סיכום תרגיל:</strong><br>
                    תשובות נכונות: ${correctCount}<br>
                    תשובות שגויות: ${wrongCount}<br>
                    תשובות חסרות: ${missingCount}<br>
                    <b>ניקוד לתרגיל: ${exerciseScore}</b>
                `;
                nextExerciseBtn.style.display = 'block';
                checkAnswerBtn.disabled = true;
                getHintBtn.disabled = true;
                showSolutionBtn.disabled = true;
            }

            function showSolution() {
                for (const angle in currentProblemSolution) {
                    const input = document.getElementById(`angle_${angle}`);
                    const feedback = document.getElementById(`feedback_${angle}`);
                    input.value = currentProblemSolution[angle];
                    input.style.backgroundColor = "#e0ffe0"; 
                    input.disabled = true;
                    feedback.textContent = '';
                }
                scoreSummary.innerHTML = 'הפתרון הוצג. לא ניתן ניקוד לתרגיל זה.';
                nextExerciseBtn.style.display = 'block';
                checkAnswerBtn.disabled = true;
                getHintBtn.disabled = true;
                showSolutionBtn.disabled = true;
            }
            
            function checkRemainingHints() {
                for (const angle in currentProblemSolution) {
                    const input = document.getElementById(`angle_${angle}`);
                    if (input && input.value === '' && !input.disabled) return true; 
                }
                return false; 
            }

            function getHint() {
                let hintGiven = false;
                for (const angle in currentProblemSolution) {
                    const input = document.getElementById(`angle_${angle}`);
                    if (input && input.value === '' && !input.disabled) {
                        input.value = currentProblemSolution[angle];
                        input.disabled = true; 
                        input.style.backgroundColor = "#fff8dc"; 
                        totalScore -= 2;
                        scoreSpan.textContent = totalScore;
                        hintGiven = true;
                        if (!checkRemainingHints()) getHintBtn.disabled = true;
                        break; 
                    }
                }
                if (!hintGiven) {
                    alert('לא נותרו רמזים זמינים.');
                    getHintBtn.disabled = true;
                }
            }

            // --- רישום מאזינים לאירועים ---
            checkAnswerBtn.addEventListener('click', checkAnswers);
            showSolutionBtn.addEventListener('click', showSolution);
            getHintBtn.addEventListener('click', getHint);
            nextExerciseBtn.addEventListener('click', generateExercise);
            difficultySelect.addEventListener('change', generateExercise);

            // --- התחלה ---
            startTimer();
            generateExercise();
        });
    </script>

</body>
</html>